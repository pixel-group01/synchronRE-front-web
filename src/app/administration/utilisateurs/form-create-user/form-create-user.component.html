<div class="container-form-user">
  <ng-container>
    <form
      class="m-1 mt-3"
      [formGroup]="userForm"
      (ngSubmit)="confirmSaveItem()"
    >
      <div
        [ngBusy]="{
          busy: busySuscription,
          message: 'Veuillez patienter ...',
          backdrop: false
        }"
      >
        <div class="row">
          <!-- Partie de droite -->
          <div class="col-md-5 col-xs-6">
            <fieldset>
              <legend>Informations sur l'utilisateur</legend>

              <div class="p-1">
                <div class="col-12 mb-3">
                  <div class="col-12 mb-3">
                    <label
                      >Type utilisateur :
                      <span class="required_champs">*</span>
                    </label>

                    <select
                      name="typeUser"
                      class="form-select"
                      formControlName="typeUser"
                    >
                      <option value=""></option>
                      <option value="Cendante">Cedante</option>
                      <option value="Coursier">Courtier</option>
                    </select>
                  </div>
                </div>

                <div
                  class="col-12 mb-3"
                  *ngIf="
                    getFormFiledsValue('typeUser') &&
                    getFormFiledsValue('typeUser')?.value?.toLowerCase() ===
                      'cendante'
                  "
                >
                  <label
                    >Cédante :
                    <span class="required_champs">*</span>
                  </label>

                  <ng-select formControlName="cedId" id="cedId">
                    <ng-option
                      *ngFor="let cedente of listeCedente"
                      [value]="cedente?.cedId"
                      >{{ cedente.cedNomFiliale }}</ng-option
                    >
                  </ng-select>
                </div>

                <div class="col-12 mb-3">
                  <label
                    >Nom :
                    <span class="required_champs">*</span>
                  </label>
                  <input
                    class="form-control custom-input"
                    placeholder="Nom"
                    autocomplete="off"
                    formControlName="lastName"
                    name="lastName"
                    [class.errorInputForm]="
                      getFormFiledsValue('lastName')?.invalid &&
                      getFormFiledsValue('lastName')?.touched
                    "
                    type="text"
                  />

                  <small
                    class="text-danger"
                    *ngIf="(getFormFiledsValue('lastName')?.dirty || getFormFiledsValue('lastName')?.touched) && getFormFiledsValue('lastName')?.invalid && getFormFiledsValue('lastName')?.errors?.['required']"
                  >
                    Ce champ est obligatoire
                  </small>
                </div>

                <div class="col-12 mb-3">
                  <label
                    >Prénoms :
                    <span class="required_champs">*</span>
                  </label>
                  <input
                    class="form-control custom-input"
                    placeholder="Prénoms"
                    autocomplete="off"
                    formControlName="firstName"
                    name="firstName"
                    [class.errorInputForm]="
                      getFormFiledsValue('firstName')?.invalid &&
                      getFormFiledsValue('firstName')?.touched
                    "
                    type="text"
                  />
                  <small
                    class="text-danger"
                    *ngIf="(getFormFiledsValue('firstName')?.dirty || getFormFiledsValue('firstName')?.touched) && getFormFiledsValue('firstName')?.invalid && getFormFiledsValue('firstName')?.errors?.['required']"
                  >
                    Ce champ est obligatoire
                  </small>
                </div>

                <div class="col-12 mb-3">
                  <label
                    >Email :
                    <span class="required_champs">*</span>
                  </label>
                  <input
                    class="form-control custom-input"
                    placeholder="Email"
                    autocomplete="off"
                    formControlName="email"
                    name="email"
                    [class.errorInputForm]="
                      getFormFiledsValue('email')?.invalid &&
                      getFormFiledsValue('email')?.touched
                    "
                    type="text"
                  />
                  <small
                    class="text-danger"
                    *ngIf="(getFormFiledsValue('email')?.dirty || getFormFiledsValue('email')?.touched) && getFormFiledsValue('email')?.invalid && getFormFiledsValue('email')?.errors?.['required']"
                  >
                    Ce champ est obligatoire
                  </small>
                </div>

                <div class="col-12 mb-3">
                  <label
                    >Téléphone :
                    <span class="required_champs">*</span>
                  </label>
                  <input
                    class="form-control custom-input"
                    placeholder="Téléphone"
                    autocomplete="off"
                    formControlName="tel"
                    name="tel"
                    [class.errorInputForm]="
                      getFormFiledsValue('tel')?.invalid &&
                      getFormFiledsValue('tel')?.touched
                    "
                    type="text"
                  />
                  <small
                    class="text-danger"
                    *ngIf="(getFormFiledsValue('tel')?.dirty || getFormFiledsValue('tel')?.touched) && getFormFiledsValue('tel')?.invalid && getFormFiledsValue('tel')?.errors?.['required']"
                  >
                    Ce champ est obligatoire
                  </small>
                </div>
              </div>
            </fieldset>
          </div>
          <!-- Partie de gauche -->

          <div class="col-md-7 col-xs-6">
            <div class="row box-fct">
              <div class="col-12 mb-3">
                <fieldset>
                  <legend>Fonction</legend>

                  <div class="p-1">
                    <div class="row">
                      <div class="col-md-6 col-xs-12 mb-3">
                        <label
                          >Libelle :
                          <span class="required_champs">*</span>
                        </label>
                        <input
                          class="form-control custom-input"
                          placeholder="Libellé"
                          autocomplete="off"
                          formControlName="libelleFonction"
                          name="libelleFonction"
                          [class.errorInputForm]="
                            getFormFiledsValue('libelleFonction')?.invalid &&
                            getFormFiledsValue('libelleFonction')?.touched
                          "
                          type="text"
                        />

                        <small
                          class="text-danger"
                          *ngIf="(getFormFiledsValue('libelleFonction')?.dirty || getFormFiledsValue('libelleFonction')?.touched) && getFormFiledsValue('libelleFonction')?.invalid && getFormFiledsValue('libelleFonction')?.errors?.['required']"
                        >
                          Ce champ est obligatoire
                        </small>
                      </div>

                      <!-- <div class="col-md-3 col-xs-12 mb-3">
                        <label
                          >Date de début
                        </label>
                        <input 
                          class="form-control custom-input"
                          placeholder="Date de début"
                          autocomplete="off"
                          bsDatepicker
                          [minDate]="dateActuelle"
                          [bsConfig]="{
                            dateInputFormat: 'DD/MM/YYYY',
                            containerClass: 'theme-dark-blue'
                          }"
                          formControlName="dateDebutFonction"
                          name="dateDebutFonction"
                          [class.errorInputForm]="
                            getFormFiledsValue('dateDebutFonction')?.invalid &&
                            getFormFiledsValue('dateDebutFonction')?.touched
                          "
                          type="text"
                        />
                        <small
                          class="text-danger"
                          *ngIf="(getFormFiledsValue('dateDebutFonction')?.dirty || getFormFiledsValue('dateDebutFonction')?.touched) && getFormFiledsValue('dateDebutFonction')?.invalid && getFormFiledsValue('dateDebutFonction')?.errors?.['required']"
                        >
                          Ce champ est obligatoire
                        </small>
                      </div> -->

                      <!-- <div class="col-md-3 col-xs-12 mb-3">
                        <label
                          >Date de fin
                        </label>
                        <input
                          class="form-control custom-input"
                          placeholder="Date de fin"
                          autocomplete="off"
                          bsDatepicker
                          [minDate]="
                            getFormFiledsValue('dateDebutFonction')?.value
                          "
                          [bsConfig]="{
                            dateInputFormat: 'DD/MM/YYYY',
                            containerClass: 'theme-dark-blue'
                          }"
                          formControlName="dateFinFonction"
                          name="dateFinFonction"
                          [class.errorInputForm]="
                            getFormFiledsValue('dateFinFonction')?.invalid &&
                            getFormFiledsValue('dateFinFonction')?.touched
                          "
                          type="text"
                        />
                        <small
                          class="text-danger"
                          *ngIf="(getFormFiledsValue('dateFinFonction')?.dirty || getFormFiledsValue('dateFinFonction')?.touched) && getFormFiledsValue('dateFinFonction')?.invalid && getFormFiledsValue('dateFinFonction')?.errors?.['required']"
                        >
                          Ce champ est obligatoire
                        </small>
                      </div> -->
                      <div class="col-md-6 col-xs-12 mb-3">
                        <label>Type de fonction :
                          <span class="required_champs">*</span>
                        </label>
                            <!-- {{userForm.value.typeFunctionId}} -->
                        <ng-select formControlName="typeFunctionId" [multiple]="false" placeholder="Choisir le type de fonction" 
                        [closeOnSelect]="true" id="fonction"   [class.errorInputForm]="
                        getFormFiledsValue('typeFunctionId')?.invalid &&
                        getFormFiledsValue('typeFunctionId')?.touched
                        ">
                          <ng-option *ngFor="let fonction of listesTypeFonctions" [value]="fonction?.typeId">{{ fonction.name
                            }}</ng-option>
                        </ng-select>

                        <small class="text-danger"
                        *ngIf="(getFormFiledsValue('typeFunctionId')?.dirty || getFormFiledsValue('typeFunctionId')?.touched) && getFormFiledsValue('typeFunctionId')?.invalid && getFormFiledsValue('typeFunctionId')?.errors?.['required']">
                        Ce champ est obligatoire
                      </small>
                      </div> 
                    </div>
                  </div>
                </fieldset>
              </div>

              <div class="col-12 mb-3 mt-3">
                <fieldset>
                  <legend>Rôles et privilèges</legend>

                  <div class="p-1">
                    <div class="col-12 mb-3">
                      <label
                        >Rôle :
                        <span class="required_champs">*</span>
                      </label>

                      <ng-select
                        formControlName="roles"
                        [multiple]="true"
                        (change)="getPrivilegeByRole()"
                        [closeOnSelect]="false"
                        id="roles"
                      >
                        <ng-option
                          *ngFor="let role of listeRoles"
                          [value]="role?.roleId"
                          >{{ role.roleName }}</ng-option
                        >
                      </ng-select>
                    </div>

                    <div class="col-12 mb-3">
                      <!-- <app-select-menu-item-privilege></app-select-menu-item-privilege> -->
                      <label
                        >Privilège :
                        <span class="required_champs">*</span>
                      </label>

                      <ng-select
                        formControlName="privileges"
                        [closeOnSelect]="false"
                        [multiple]="true"
                        [readonly]="true"
                        id="privileges"
                      >
                        <ng-option
                          *ngFor="let privilege of listePrivileges"
                          [value]="privilege?.privilegeId"
                          >{{ privilege.privilegeName }}</ng-option
                        >
                      </ng-select>
                    </div>
                  </div>
                </fieldset>
              </div>


              <div class="row">
                <div class="col-md-9"></div>
                <div class="col-md-3 pull-right">
                  <button
                    type="button"
                    (click)="addFonction()"
                    class="btn btn-md custom_btn_primary pull-right"
                  >
                    Ajouter
                  </button>
                </div>
              </div>

              <div class="row">
                <div class="col-md-12 mt-3">
                  <table>
                    <thead>
                      <tr class="custom-table-head">
                        <th colspan="2" style="padding:5px">Liste des fonctions</th>
                      </tr>
                    </thead>

                    <tbody>
                      <tr *ngFor="let fct of listeFonctions; let indice = index">
                        <td>
                          {{ fct.name }}
                        </td>
                        <td style="width: 70px;text-align: center;">
                          <a
                            (click)="deleteFonction(indice)"
                            style="color: rgb(224, 87, 87); cursor: pointer"
                          >
                            <i class="fa fa-trash"></i
                          ></a>
                        </td>
                      </tr>

                      <tr *ngIf="listeFonctions.length == 0">
                        <td colspan="2" class="txt-align-center">
                          Aucune données disponible
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

            </div>


          </div>
        </div>

        <div class="custom-btn-save-manager">
          <button
            type="submit"
            class="btn btn-md custom_btn_primary pull-right"
            [disabled]="!userForm.valid"
          >
            {{ !itemToUpdate ? "Enregistrer" : "Modifier" }}
          </button>

          <button
            type="button"
            class="btn btn-md btn-cancel pull-right"
            (click)="closeModalUser()"
          >
            Annuler
          </button>
        </div>
      </div>
    </form>
  </ng-container>
</div>
